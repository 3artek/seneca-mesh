<!DOCTYPE html>

<html>
<head>
  <title>mesh.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>mesh.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
  MIT License,
  Copyright (c) 2015-2016, Richard Rodger and other contributors.
*/</span>
<span class="hljs-meta">
'use strict'</span>

<span class="hljs-keyword">var</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>)
<span class="hljs-keyword">var</span> Jsonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonic'</span>)
<span class="hljs-keyword">var</span> Sneeze = <span class="hljs-built_in">require</span>(<span class="hljs-string">'sneeze'</span>)
<span class="hljs-keyword">var</span> Nid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nid'</span>)
<span class="hljs-keyword">var</span> Rif = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rif'</span>)
<span class="hljs-keyword">var</span> Discover = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-discover'</span>)
<span class="hljs-keyword">var</span> Ip = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ip'</span>)

<span class="hljs-built_in">module</span>.exports = mesh
<span class="hljs-built_in">module</span>.exports.resolve_bases = resolve_bases

<span class="hljs-keyword">var</span> DEFAULT_HOST = <span class="hljs-built_in">module</span>.exports.DEFAULT_HOST = <span class="hljs-string">'127.0.0.1'</span>
<span class="hljs-keyword">var</span> DEFAULT_PORT = <span class="hljs-built_in">module</span>.exports.DEFAULT_PORT = <span class="hljs-number">39999</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mesh</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> seneca = <span class="hljs-keyword">this</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Default option values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options = seneca.util.deepextend({
    auto: <span class="hljs-literal">true</span>,
    make_entry: default_make_entry,

    discover: {
      defined: <span class="hljs-literal">true</span>,
      guess: <span class="hljs-literal">true</span>,
      multicast: {
        address: <span class="hljs-literal">null</span>,
        max_search: <span class="hljs-number">22</span>,
        search_interval: <span class="hljs-number">111</span>,
      },
      registry: {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>check registry periodically</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        refresh_interval: <span class="hljs-number">1111</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>remove first entry with this probability
live bases nodes will add themselves back in</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        prune_first_probability: <span class="hljs-number">0.01</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>leave at least this many base entries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        prune_bound: <span class="hljs-number">11</span>
      },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>stop discovery if defined bases are provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      stop: <span class="hljs-literal">true</span>
    },

    dumpnet: <span class="hljs-literal">false</span>
  }, options)


  <span class="hljs-keyword">var</span> bases = []
  <span class="hljs-keyword">var</span> sneeze

  seneca.add(<span class="hljs-string">'role:mesh,get:bases'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_bases</span> (<span class="hljs-params">msg, done</span>) </span>{
    done( <span class="hljs-literal">null</span>, {bases:[].concat(bases)} )
  })

  <span class="hljs-keyword">var</span> balance_map = {}
  <span class="hljs-keyword">var</span> mid = Nid()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>fixed network interface specification, as per format of
require(‘os’).networkInterfaces. Merged with and overrides same.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> rif = Rif(options.netif)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>options.base is deprecated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> isbase = !!(options.isbase || options.base)
  options.isbase = isbase

  <span class="hljs-keyword">var</span> pin = options.pin || options.pins

  <span class="hljs-keyword">if</span>( isbase ) {
    pin = pin || <span class="hljs-string">'role:mesh,base:true'</span>
  }

  options.host = resolve_interface(options.host, rif)
  <span class="hljs-keyword">var</span> tag = options.tag

  <span class="hljs-keyword">var</span> listen = options.listen || [{pin:pin, model:options.model||<span class="hljs-string">'consume'</span>}]

  <span class="hljs-keyword">var</span> balance_client_opts = options.balance_client || {}
  seneca.use( <span class="hljs-string">'balance-client$mesh~'</span>+mid, balance_client_opts )

  <span class="hljs-keyword">if</span>( options.dumpnet ) {
    <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>)
      .exec(<span class="hljs-string">'ifconfig -a'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, stdout, stderr</span>) </span>{
        <span class="hljs-keyword">if</span> (error) {
          <span class="hljs-built_in">console</span>.error(error)
        }
        <span class="hljs-built_in">console</span>.log(stdout)
        <span class="hljs-built_in">console</span>.log(stderr)
      })
  }


  seneca.add(<span class="hljs-string">'init:mesh'</span>, init)

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span> (<span class="hljs-params">msg, done</span>) </span>{

    find_bases( seneca, options, rif, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">found_bases</span>) </span>{
      <span class="hljs-built_in">console</span>.log(options)

      bases = found_bases

      seneca.log.info({kind:<span class="hljs-string">'mesh'</span>,host:options.host,port:options.port,bases:bases})
      <span class="hljs-keyword">var</span> sneeze_opts = options.sneeze || {}

      sneeze_opts.bases = bases
      sneeze_opts.isbase = isbase
      sneeze_opts.port = options.port || <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
      sneeze_opts.host = options.host || <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>
      sneeze_opts.identifier = seneca.id

      sneeze_opts.tag 
        =  ( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> !== sneeze_opts.tag ? sneeze_opts.tag : 
             <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> !== tag ? 
             (<span class="hljs-literal">null</span> === tag ? <span class="hljs-literal">null</span> : <span class="hljs-string">'seneca~'</span>+tag) 
             : <span class="hljs-string">'seneca~mesh'</span> )

      seneca.add( <span class="hljs-string">'role:transport,cmd:listen'</span>, transport_listen )</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>call seneca.listen as a convenience
subsequent seneca.listen calls will still publish to network</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( options.auto ) {
        _.each( listen, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> listen_opts </span>) </span>{

          <span class="hljs-keyword">if</span>( options.host &amp;&amp; <span class="hljs-literal">null</span> == listen_opts.host ) {
            listen_opts.host = options.host
          }

          <span class="hljs-keyword">if</span>( <span class="hljs-string">'@'</span> === (listen_opts.host &amp;&amp; listen_opts.host[<span class="hljs-number">0</span>]) ) {
            listen_opts.host = rif(listen_opts.host.substring(<span class="hljs-number">1</span>))
          }

          listen_opts.port = <span class="hljs-literal">null</span> != listen_opts.port ? listen_opts.port : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-number">50000</span> + <span class="hljs-built_in">Math</span>.floor((<span class="hljs-number">10000</span>*<span class="hljs-built_in">Math</span>.random()))
          }

          listen_opts.model = listen_opts.model || <span class="hljs-string">'consume'</span>
          
          seneca.root.listen( listen_opts )
        })
      }


      <span class="hljs-keyword">return</span> done()

      
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transport_listen</span> (<span class="hljs-params">msg, done</span>) </span>{
        <span class="hljs-keyword">this</span>.prior( msg, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> err, out </span>) </span>{
          <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span> done( err )

          join( <span class="hljs-keyword">this</span>, out, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            done()
          })
        })
      }

      
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">join</span>(<span class="hljs-params"> instance, config, done </span>) </span>{
        config = config || {}

        <span class="hljs-keyword">if</span>( !config.pin &amp;&amp; !config.pins ) {
          config.pin = <span class="hljs-string">'null:true'</span>
        }

        <span class="hljs-keyword">var</span> instance_sneeze_opts = _.clone( sneeze_opts )
        instance_sneeze_opts.identifier = 
          sneeze_opts.identifier + <span class="hljs-string">'~'</span> +
          seneca.util.pincanon(config.pin||config.pins) + <span class="hljs-string">'~'</span> + <span class="hljs-built_in">Date</span>.now()

        sneeze = Sneeze( instance_sneeze_opts )
        
        <span class="hljs-keyword">var</span> meta = {
          config: config,
          instance: instance.id,
        }

        sneeze.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>{
          seneca.log.warn(err)
        })
        sneeze.on(<span class="hljs-string">'add'</span>, add_client)
        sneeze.on(<span class="hljs-string">'remove'</span>, remove_client)
        sneeze.on(<span class="hljs-string">'ready'</span>, done)

        seneca.add(<span class="hljs-string">'role:seneca,cmd:close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msg, done</span>) </span>{
          <span class="hljs-keyword">if</span>( sneeze ) {
            sneeze.leave()
          }
          <span class="hljs-keyword">this</span>.prior(msg, done)
        })


        seneca.add( <span class="hljs-string">'role:mesh,get:members'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_members</span> (<span class="hljs-params">msg, done</span>) </span>{
          <span class="hljs-keyword">var</span> members = []

          _.each( sneeze.members(), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">member</span>) </span>{
            <span class="hljs-keyword">var</span> m = options.make_entry(member)
            members.push( <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> === m ? default_make_entry(member) : m )
          })

          <span class="hljs-keyword">this</span>.prior( msg, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> err, out </span>) </span>{
            <span class="hljs-keyword">var</span> list = out &amp;&amp; out.list || []
            <span class="hljs-keyword">var</span> outlist = list.concat(members)

            done( <span class="hljs-literal">null</span>, {list:outlist} )
          })
        })


        sneeze.join( meta )

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_client</span>(<span class="hljs-params"> meta </span>) </span>{
          <span class="hljs-keyword">var</span> config = meta.config || {}

          <span class="hljs-keyword">var</span> pins = config.pins || config.pin || []
          pins = _.isArray(pins) ? pins : [pins]

          _.each( pins, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> pin </span>) </span>{
            <span class="hljs-keyword">var</span> pin_id = instance.util.pattern(pin)
            <span class="hljs-keyword">var</span> has_balance_client = !!balance_map[pin_id]
            <span class="hljs-keyword">var</span> target_map = (balance_map[pin_id] = balance_map[pin_id] || {})

            <span class="hljs-keyword">var</span> pin_config = _.clone( config )
            <span class="hljs-keyword">delete</span> pin_config.pins
            <span class="hljs-keyword">delete</span> pin_config.pin

            pin_config.pin = pin_id

            <span class="hljs-keyword">var</span> id = instance.util.pattern( pin_config )+<span class="hljs-string">'~'</span>+meta.identifier$</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>this is a duplicate, so ignore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>( target_map[id] ) {
              <span class="hljs-keyword">return</span>
            }

            pin_config.id = id</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO: how to handle local override?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> actmeta = instance.find( pin )
            <span class="hljs-keyword">var</span> ignore_client = !!(actmeta &amp;&amp; !actmeta.client)

            <span class="hljs-keyword">if</span>( ignore_client ) {
              <span class="hljs-keyword">return</span>
            }


            <span class="hljs-keyword">if</span>( !has_balance_client ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>no balancer for this pin, so add one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              instance.root.client( {type:<span class="hljs-string">'balance'</span>, pin:pin, model:config.model} )
            }

            target_map[id] = <span class="hljs-literal">true</span>

            instance.act( 
              <span class="hljs-string">'role:transport,type:balance,add:client'</span>, 
              {config:pin_config} ) 
          })
        }


        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remove_client</span>(<span class="hljs-params"> meta </span>) </span>{
          <span class="hljs-keyword">var</span> config = meta.config || {}

          <span class="hljs-keyword">var</span> pins = config.pins || config.pin || []
          pins = _.isArray(pins) ? pins : [pins]

          _.each( pins, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> pin </span>) </span>{
            <span class="hljs-keyword">var</span> pin_id = instance.util.pattern(pin)

            <span class="hljs-keyword">var</span> pin_config = _.clone( config )
            <span class="hljs-keyword">delete</span> pin_config.pins
            <span class="hljs-keyword">delete</span> pin_config.pin

            pin_config.pin = pin_id

            <span class="hljs-keyword">var</span> id = instance.util.pattern( pin_config )+<span class="hljs-string">'~'</span>+meta.identifier$
            pin_config.id = id

            <span class="hljs-keyword">var</span> target_map = balance_map[pin_id]

            <span class="hljs-keyword">if</span>( target_map ) {
              <span class="hljs-keyword">delete</span> target_map[id]
            }

            instance.act( 
              <span class="hljs-string">'role:transport,type:balance,remove:client'</span>, 
              {config:pin_config} ) 
          })
        }
      }
    })
  }
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve_interface</span> (<span class="hljs-params">spec, rif</span>) </span>{
  <span class="hljs-keyword">var</span> out = spec

  spec = <span class="hljs-literal">null</span> == spec ? <span class="hljs-string">''</span> : spec

  <span class="hljs-keyword">if</span>( <span class="hljs-string">'@'</span> === spec[<span class="hljs-number">0</span>] ) {
    <span class="hljs-keyword">if</span>( <span class="hljs-number">1</span> === spec.length ) {
      out = <span class="hljs-string">'0.0.0.0'</span>
    }
    <span class="hljs-keyword">else</span> {
      out = rif(spec.substring(<span class="hljs-number">1</span>))
    }
  }

  <span class="hljs-keyword">return</span> out
}



<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find_bases</span> (<span class="hljs-params">seneca, options, rif, done</span>) </span>{
  <span class="hljs-keyword">var</span> bases = []

  options.discover = options.discover || {}
  addbase_funcmap.custom = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">seneca, options, bases, next</span>) </span>{
    options.discover.custom(seneca, options, bases, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">add, stop</span>) </span>{
      add = add || []
      next( add, <span class="hljs-literal">null</span> == stop ? <span class="hljs-number">0</span> &lt; add.length : !!stop )
    })}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>order is significant</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> addbases = [
    <span class="hljs-string">'defined'</span>,
    <span class="hljs-string">'registry'</span>,
    <span class="hljs-string">'multicast'</span>,
    <span class="hljs-string">'custom'</span>,
    <span class="hljs-string">'guess'</span>,
  ]

  <span class="hljs-keyword">var</span> abI = <span class="hljs-number">-1</span>
  <span class="hljs-keyword">var</span> addbase

  next()

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">next</span> (<span class="hljs-params">add, stop</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>console.log(addbase,add)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bases = bases.concat(add || [])
    <span class="hljs-keyword">if</span> (stop &amp;&amp; options.discover.stop) abI = addbases.length

    ++abI

    <span class="hljs-keyword">while</span> (!truthy(options.discover[addbases[abI]]) 
           &amp;&amp; abI &lt; addbases.length) 
    { ++abI }

    addbase = addbases[abI]

    <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> == addbase ) {
      bases = resolve_bases( 
        bases,
        options,
        rif
      )

      <span class="hljs-keyword">return</span> done(bases)
    }

    addbase_funcmap[addbase](seneca, options, bases, next)
  }
}

<span class="hljs-keyword">var</span> addbase_funcmap = {
  defined: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">seneca, options, bases, next</span>) </span>{
    <span class="hljs-keyword">var</span> add = 
          (options.sneeze||{}).bases || options.bases || options.remotes || []

    add = add.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">base</span>) </span>{
      <span class="hljs-keyword">return</span> base &amp;&amp; <span class="hljs-number">0</span> &lt; base.length
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>console.log(‘FB defined’,add)    </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    next(add, <span class="hljs-number">0</span> &lt; add.length)
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>order significant! depends on defined as uses bases.length</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  guess: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">seneca, options, bases, next</span>) </span>{
    <span class="hljs-keyword">var</span> add = []
    <span class="hljs-keyword">var</span> host = options.host

    <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> === bases.length ) {
      <span class="hljs-keyword">if</span>( <span class="hljs-literal">null</span> != host &amp;&amp; host !== DEFAULT_HOST ) {
        add.push(host+<span class="hljs-string">':'</span>+DEFAULT_PORT)
      }
      add.push(DEFAULT_HOST+<span class="hljs-string">':'</span>+DEFAULT_PORT)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>console.log(‘FB guess’,add)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    next(add)
  },

  multicast: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">seneca, options, bases, next</span>) </span>{
    <span class="hljs-keyword">var</span> add = []
    <span class="hljs-keyword">var</span> opts = ((options.discover||{}).multicast||{})</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Determine broadcast address using subnetmask</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( _.isString(opts.address) &amp;&amp; <span class="hljs-string">'/'</span> === opts.address[<span class="hljs-number">0</span>] ) {
      <span class="hljs-keyword">var</span> netprefix = <span class="hljs-built_in">parseInt</span>(opts.address.substring(<span class="hljs-number">1</span>))
      opts.address = Ip.subnet(options.host,Ip.fromPrefixLen(netprefix)).broadcastAddress
    }

    <span class="hljs-keyword">var</span> d = Discover({
      broadcast: opts.address,
      advertisement: {
        seneca_mesh: <span class="hljs-literal">true</span>,
        isbase: options.isbase,
        host: options.host || DEFAULT_HOST,
        port: options.port || DEFAULT_PORT
      }
    })

    <span class="hljs-keyword">var</span> findCount = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> fi = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>
      d.eachNode(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">node</span>) </span>{
        <span class="hljs-keyword">var</span> nd = node.advertisement
        <span class="hljs-keyword">if</span>( nd.seneca_mesh ) {
          add.push(nd.host+<span class="hljs-string">':'</span>+nd.port)
          count++
        }
      })

      <span class="hljs-keyword">if</span>( <span class="hljs-number">0</span> &lt; count || opts.max_search &lt; findCount ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>only bases should keep broadcasting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( !options.isbase ) { 
          d.stop()
        }

        clearInterval(fi)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>console.log(‘FB multicast’,add)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        next(add, <span class="hljs-number">0</span> &lt; add.length)
      }

      findCount++
    }, opts.search_interval)
  },

  
  registry: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">seneca, options, bases, next</span>) </span>{  
    <span class="hljs-keyword">var</span> first = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">var</span> base_addr = (options.host||DEFAULT_HOST)+<span class="hljs-string">':'</span>+
          (options.port||DEFAULT_PORT)
    
    <span class="hljs-keyword">if</span>( options.isbase ) {
      <span class="hljs-keyword">var</span> ri = options.discover.registry.refresh_interval
      ri = ri+(ri*(<span class="hljs-built_in">Math</span>.random()<span class="hljs-number">-0.5</span>))
      setInterval(getset_bases, ri)
    }

    getset_bases()
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getset_bases</span>(<span class="hljs-params"></span>) </span>{
      seneca.act(
        <span class="hljs-string">'role:registry,cmd:get,default$:{}'</span>,
        {key:<span class="hljs-string">'seneca-mesh/'</span>+(options.tag||<span class="hljs-string">'-'</span>)+<span class="hljs-string">'/bases'</span>},
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, out</span>) </span>{
          <span class="hljs-keyword">if</span>( err ) <span class="hljs-keyword">return</span>

          <span class="hljs-keyword">var</span> add = (out.value||<span class="hljs-string">''</span>).split(<span class="hljs-string">','</span>)
          add = add.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">base</span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span> &lt; base.length
          })

          <span class="hljs-keyword">if</span>( first ) {
            first = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>console.log(‘FB registry’,add)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            next(add, <span class="hljs-number">0</span> &lt; add.length)
          }

          <span class="hljs-keyword">if</span>( options.isbase ) {
            <span class="hljs-keyword">var</span> prune_first = <span class="hljs-built_in">Math</span>.random() &lt; 
                  options.discover.registry.prune_first_probability

            <span class="hljs-keyword">if</span>( prune_first || <span class="hljs-number">-1</span> === add.indexOf(base_addr) ) {
              add.push(base_addr)
              add = _.uniq(add)

              <span class="hljs-keyword">if</span>( prune_first &amp;&amp; options.discover.registry.prune_bound &lt; add.length ) {
                add.shift()
              }

              <span class="hljs-keyword">var</span> val = add.join(<span class="hljs-string">','</span>)
              
              seneca.act(
                <span class="hljs-string">'role:registry,cmd:set,default$:{}'</span>,
                {
                  key:<span class="hljs-string">'seneca-mesh/'</span>+(options.tag||<span class="hljs-string">'-'</span>)+<span class="hljs-string">'/bases'</span>, 
                  value:val
                })
            }
          }
        })
    }
  }
}  


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">default_make_entry</span> (<span class="hljs-params">member</span>) </span>{
  <span class="hljs-keyword">var</span> entry = member

  <span class="hljs-keyword">if</span>( member.tag$.match(<span class="hljs-regexp">/^seneca~/</span>) ) {
    entry = {
      pin: member.config.pin,
      port: member.config.port,
      host: member.config.host,
      type: member.config.type,
      model: member.config.model,
      instance: member.instance
    }
  }

  <span class="hljs-keyword">return</span> entry
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolve_bases</span> (<span class="hljs-params">orig_bases, options, rif</span>) </span>{
  options = options || {}

  <span class="hljs-keyword">var</span> host = options.host</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>remove empties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> bases = (orig_bases || []).filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">base</span>) </span>{
    <span class="hljs-keyword">return</span> base &amp;&amp; <span class="hljs-number">0</span> &lt; base.length
  })

  <span class="hljs-keyword">var</span> append = []</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>first pass: defaults and interfacesx</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bases = bases.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">base</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>host:port -&gt; host:port
:port -&gt; DEFAULT_HOST:port, host:port
host -&gt; host:DEFAULT_PORT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> parts = base.match(<span class="hljs-regexp">/^(.+):(\d+)$/</span>)
    <span class="hljs-keyword">if</span>( parts ) {
      parts = parts.slice(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>)
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span>( <span class="hljs-string">':'</span> === base[<span class="hljs-number">0</span>] ) {
        parts = [DEFAULT_HOST, base.substring(<span class="hljs-number">1</span>)]
        <span class="hljs-keyword">if</span>( host ) {
          append.push(host+<span class="hljs-string">':'</span>+parts[<span class="hljs-number">1</span>])
        }
      }
      <span class="hljs-keyword">else</span> {
        parts = [base, DEFAULT_PORT]
      }
    }

    <span class="hljs-keyword">if</span>( <span class="hljs-string">'@'</span> === (parts[<span class="hljs-number">0</span>] &amp;&amp; parts[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]) ) {
      parts[<span class="hljs-number">0</span>] = rif(parts[<span class="hljs-number">0</span>].substring(<span class="hljs-number">1</span>))
    }    

    <span class="hljs-keyword">return</span> parts.join(<span class="hljs-string">':'</span>)
  })
  
  bases = bases.concat(append)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>second pass: ranges
host:10-12 -&gt; host:10, host:11, host:12
a.b.c.10-12:port -&gt; a.b.c.10:port, a.b.c.11:port, a.b.c.12:port </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">return</span> bases
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">truthy</span> (<span class="hljs-params">v</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">'false'</span> === v ? <span class="hljs-literal">false</span> : !!v
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
